<html>
	<head>
		<title>Msg - Queues</title>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
 		<style>
 		table.data {
 			width: 100%;
 		}
 		table.data td {
 			border: 1px black solid;
 		}

 		.delete {
 			cursor:pointer;
 		}

 		</style>
		<script>
		var Msg = {
			Config: {
				endpoint: "https://apps.moinz.de/msg/msg.php",
				username: "",
				password: ""
			},
			DescribeQueues: function() {
				return jQuery.post(this.Config.endpoint + "?action=DescribeQueues",""); 
			},
			DescribeQueueStatus: function(queueId) {
				return jQuery.post(this.Config.endpoint + "?action=DescribeQueueStatus&queue=" + queueId,""); 	
			},
			CreateQueue: function(tags) {
				var url = this.Config.endpoint + "?action=CreateQueue";

				var index = 1;
				jQuery.each(tags, function (key, value) {
					url += "&tags."  + index + ".key=" + key;
					url += "&tags." + index + ".value=" + value;
					index++;
				});

				return jQuery.post(url, "");
			},
			DeleteQueue: function(queueId) {
				return jQuery.post(this.Config.endpoint + "?action=DeleteQueue&queue=" + queueId, "");
			}
		}

		var QueuesOverviewComponent = {
			el: jQuery("#queues"),
			render: function () {
				var that = this;
				Msg.DescribeQueues().then(function (response) {
					that.el.empty();
					jQuery(response.queues).each(function (index, queue) {
						var tagText = "";
						jQuery(queue.tags).each(function (index, tag) {
							tagText += ", " + tag.key + "=" + tag.value;
						})
						var el = jQuery("<tr><td>" + queue.id + "</td>" + 
							"<td>" + tagText.substring(2) + "</td>" + 
							"<td class=state></td>" +
							"<td class=delete>[ Delete ]</td>" + 
							"</tr>");
						el.appendTo(that.el);

						Msg.DescribeQueueStatus(queue.id).done(function(queueStatus) {
							var status = jQuery(".state", el);
							status.text(queueStatus.messages);
						});

						jQuery(".delete", el).on("click", function() {
							Msg.DeleteQueue(queue.id).then(function() {
								QueuesOverviewComponent.render();
							});
						});
					})	
				});
			},

			init: function() {
				this.el = jQuery("#queues");
			}
		};

		var CreateQueueComponent = {
			el: undefined,
			tags: undefined,

			init: function() {
				this.el = jQuery("#create_queue");
				this.tags = jQuery("#queue_tags");

				jQuery("button", this.el).on("click", function() {
					var tags = CreateQueueComponent.tags.val();

					var requestTags = {};

					jQuery.each(tags.split(","), function(index, pair) {
						var elements = pair.split("=");

						requestTags[elements[0]] = elements[1];
					});

					Msg.CreateQueue(requestTags).then(function() {
						CreateQueueComponent.reset();
						Bus.queueCreated();
					});
				})
			},

			reset: function() {
				this.tags.text("");
			}
		};

		var Bus = {
			queueCreated: function () {
				QueuesOverviewComponent.render();
			}
		};

		$(document).ready(function() {
			CreateQueueComponent.init();
			QueuesOverviewComponent.init();
			QueuesOverviewComponent.render();
		});

		</script>

	</head>
	<body>
		<h1>Queues</h1>

		<div id="create_queue">
			<fieldset>
				<span>
					Tags: <input type="text" id="queue_tags">
				</span>
				<span>
					<button>Create Queue</button>
				</span>
			</fieldset>
		</div>
		<hr />
		<table class="data">
			<thead>
				<tr>
					<th>ID</th>
					<th>Tags</th>
					<th>Messages#</th>
				</tr>
			</thead>
			<tbody id="queues">

			</tbody>
		</table>
	</body>
</html>